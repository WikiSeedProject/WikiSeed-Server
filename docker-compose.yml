# WikiSeed Server - Docker Compose Configuration
# Production deployment with all 8 containers

services:
  # 1. Controller - Central orchestration and job scheduling
  controller:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: wikiseed-controller
    restart: unless-stopped
    command: python -m src.controller
    environment:
      - CONFIG_PATH=/config/config.yaml
      - DATABASE_PATH=/data/db/jobs.db
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
    env_file:
      - .env
    volumes:
      - ./config.yaml:/config/config.yaml:ro
      - ./data/db:/data/db
      - ./data/dumps:/data/dumps:ro
      - ./data/torrents:/data/torrents:ro
    depends_on:
      - db-init
    networks:
      - wikiseed-net

  # 2. Scraper - Discover dumps and archive pages
  scraper:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: wikiseed-scraper
    restart: unless-stopped
    command: python -m src.scraper
    environment:
      - CONFIG_PATH=/config/config.yaml
      - DATABASE_PATH=/data/db/jobs.db
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
    env_file:
      - .env
    volumes:
      - ./config.yaml:/config/config.yaml:ro
      - ./data/db:/data/db
    depends_on:
      - db-init
    networks:
      - wikiseed-net

  # 3. Downloader - Download dump files
  downloader:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: wikiseed-downloader
    restart: unless-stopped
    command: python -m src.downloader
    environment:
      - CONFIG_PATH=/config/config.yaml
      - DATABASE_PATH=/data/db/jobs.db
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
    env_file:
      - .env
    volumes:
      - ./config.yaml:/config/config.yaml:ro
      - ./data/db:/data/db
      - ./data/dumps:/data/dumps
    depends_on:
      - db-init
    networks:
      - wikiseed-net

  # 4. Uploader - Upload to Internet Archive
  uploader:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: wikiseed-uploader
    restart: unless-stopped
    command: python -m src.uploader
    environment:
      - CONFIG_PATH=/config/config.yaml
      - DATABASE_PATH=/data/db/jobs.db
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - IA_ACCESS=${IA_ACCESS}
      - IA_SECRET=${IA_SECRET}
    env_file:
      - .env
    volumes:
      - ./config.yaml:/config/config.yaml:ro
      - ./data/db:/data/db
      - ./data/dumps:/data/dumps:ro
    depends_on:
      - db-init
    networks:
      - wikiseed-net

  # 5. Creator - Create torrents and metadata
  creator:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: wikiseed-creator
    restart: unless-stopped
    command: python -m src.creator
    environment:
      - CONFIG_PATH=/config/config.yaml
      - DATABASE_PATH=/data/db/jobs.db
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
    env_file:
      - .env
    volumes:
      - ./config.yaml:/config/config.yaml:ro
      - ./data/db:/data/db
      - ./data/dumps:/data/dumps:ro
      - ./data/torrents:/data/torrents
      - ./data/seeder/watch:/data/seeder/watch
    depends_on:
      - db-init
    networks:
      - wikiseed-net

  # 6. Publisher - Publish to R2, Gist, pastebin
  publisher:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: wikiseed-publisher
    restart: unless-stopped
    command: python -m src.publisher
    environment:
      - CONFIG_PATH=/config/config.yaml
      - DATABASE_PATH=/data/db/jobs.db
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - R2_ACCOUNT_ID=${R2_ACCOUNT_ID}
      - R2_ACCESS_KEY_ID=${R2_ACCESS_KEY_ID}
      - R2_SECRET_ACCESS_KEY=${R2_SECRET_ACCESS_KEY}
      - GIST_TOKEN=${GIST_TOKEN}
      - PASTEBIN_API_KEY=${PASTEBIN_API_KEY}
    env_file:
      - .env
    volumes:
      - ./config.yaml:/config/config.yaml:ro
      - ./data/db:/data/db
      - ./data/torrents:/data/torrents:ro
    depends_on:
      - db-init
    networks:
      - wikiseed-net

  # 7. Seeder - qBittorrent for torrent seeding
  seeder:
    image: linuxserver/qbittorrent:latest
    container_name: wikiseed-seeder
    restart: unless-stopped
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=UTC
      - WEBUI_PORT=8080
    volumes:
      - ./data/seeder/config:/config
      - ./data/seeder/watch:/watch
      - ./data/torrents:/data/torrents:ro
    ports:
      - "6881:6881"       # BitTorrent port (TCP)
      - "6881:6881/udp"   # BitTorrent port (UDP)
      - "8080:8080"       # qBittorrent Web UI (localhost only - use SSH tunnel)
    networks:
      - wikiseed-net

  # 8. Monitor - Web UI and REST API
  monitor:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: wikiseed-monitor
    restart: unless-stopped
    command: python -m src.monitor
    environment:
      - CONFIG_PATH=/config/config.yaml
      - DATABASE_PATH=/data/db/jobs.db
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - FLASK_ENV=production
    env_file:
      - .env
    volumes:
      - ./config.yaml:/config/config.yaml:ro
      - ./data/db:/data/db:ro
      - ./data/dumps:/data/dumps:ro
      - ./data/torrents:/data/torrents:ro
    ports:
      - "8000:8000"  # Monitor Web UI (localhost only - use SSH tunnel)
    depends_on:
      - db-init
    networks:
      - wikiseed-net

  # Database initialization (run once)
  db-init:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: wikiseed-db-init
    command: python scripts/init_db.py
    environment:
      - DATABASE_PATH=/data/db/jobs.db
    volumes:
      - ./data/db:/data/db
      - ./migrations:/app/migrations:ro
    networks:
      - wikiseed-net
    restart: "no"

networks:
  wikiseed-net:
    driver: bridge

# Named volumes for persistence (optional - using bind mounts by default)
# Uncomment if you prefer Docker-managed volumes over bind mounts
# volumes:
#   db-data:
#   dumps-data:
#   torrents-data:
#   seeder-config:
